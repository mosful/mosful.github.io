<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ¨‚ç«è»Šæ•¸å­¸å¤§å†’éšª</title>
    <style>
        /* --- 1. å…¨åŸŸè¨­å®š --- */
        body {
            font-family: 'Comic Sans MS', 'Microsoft JhengHei', sans-serif;
            background-color: #E0F7FA;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
            user-select: none;
        }

        /* --- 2. éŠæˆ²ä¸»å®¹å™¨ --- */
        .game-container {
            background-color: #FFFFFF;
            width: 90%;
            max-width: 600px;
            border-radius: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            border: 6px solid #4DD0E1;
            position: relative;
            overflow: hidden;
            display: flex;       /* è®“å…§éƒ¨å…ƒç´ å¯ä»¥æ’åˆ— */
            flex-direction: column;
            min-height: 550px;   /* å›ºå®šæœ€å°é«˜åº¦ï¼Œç¢ºä¿ç‰ˆé¢ç©©å®š */
        }

        /* å…§å®¹å€åŸŸè‡ªå‹•æ’é–‹ */
        .content-wrapper {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* --- 3. æ¨™é¡Œèˆ‡åœ–ç¤º --- */
        h1 {
            color: #00838F;
            font-size: 2.2rem;
            margin: 10px 0;
            text-shadow: 1px 1px 0px #FFF;
        }
        
        .train-icon {
            font-size: 4.5rem;
            margin: 15px 0;
            display: inline-block;
            animation: trainMove 2s infinite ease-in-out;
        }

        /* --- 4. æŒ‰éˆ•æ¨£å¼ --- */
        .btn {
            background-color: #FF7043;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.4rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 6px 0 #D84315;
            transition: transform 0.1s;
            width: 85%;
            max-width: 320px;
        }

        .btn:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #D84315;
        }

        .btn-secondary {
            background-color: #26A69A;
            box-shadow: 0 6px 0 #00695C;
        }

        .btn-secondary:active {
            box-shadow: 0 0 0 #00695C;
        }

        /* --- 5. éŠæˆ²ç•«é¢å…ƒç´  --- */
        #game-screen, #result-screen {
            display: none;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            font-size: 1.3rem;
            color: #555;
            background: #E1F5FE;
            padding: 10px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .question-box {
            background-color: #FFF3E0;
            border: 3px dashed #FFAB91;
            padding: 25px;
            border-radius: 20px;
            font-size: 2rem;
            font-weight: bold;
            color: #D84315;
            margin: 10px 0 25px 0;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.4;
        }

        /* --- 6. é¸é …æŒ‰éˆ•å€ --- */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .option-btn {
            background-color: #4FC3F7;
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            padding: 20px;
            border: none;
            border-radius: 18px;
            box-shadow: 0 5px 0 #0277BD;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-btn:active {
            transform: translateY(5px);
            box-shadow: none;
        }

        .correct-anim { background-color: #66BB6A !important; box-shadow: 0 5px 0 #2E7D32 !important; transform: scale(1.05); }
        .wrong-anim { background-color: #EF5350 !important; box-shadow: 0 5px 0 #C62828 !important; animation: shake 0.4s; }

        /* --- 7. å‹•ç•« --- */
        @keyframes trainMove {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(-5deg); }
            75% { transform: translateY(-5px) rotate(5deg); }
        }

        @keyframes shake {
            0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 50% { transform: translateX(10px); } 75% { transform: translateX(-10px); } 100% { transform: translateX(0); }
        }

        /* --- 8. åº•éƒ¨è¦å‰‡æé†’ (æ–°å¢æ¨£å¼) --- */
        .rules-footer {
            margin-top: 20px;
            border-top: 2px solid #EEE;
            padding-top: 15px;
            font-size: 0.8rem; /* å­—é«”åå° */
            color: #90A4AE;    /* æ·¡ç°è‰²ï¼Œä¸æ˜é¡¯ */
            line-height: 1.6;
        }

        @media (max-width: 480px) {
            h1 { font-size: 1.8rem; }
            .question-box { font-size: 1.5rem; padding: 15px; }
            .options-grid { grid-template-columns: 1fr; }
            .option-btn { font-size: 1.6rem; padding: 15px; }
            .game-container { min-height: auto; }
        }
    </style>
</head>
<body>

    <div class="game-container">
        <audio id="sound-train" preload="auto" src="https://upload.wikimedia.org/wikipedia/commons/5/53/Steam_train_whistle_02.ogg"></audio>
        <audio id="sound-correct" preload="auto" src="https://upload.wikimedia.org/wikipedia/commons/3/3b/Bubble_pop_one.ogg"></audio>
        <audio id="sound-wrong" preload="auto" src="https://upload.wikimedia.org/wikipedia/commons/b/b4/Buzzer_02.ogg"></audio>

        <div class="content-wrapper">
            <div id="start-screen">
                <div class="train-icon">ğŸš‚</div>
                <h1>å¿«æ¨‚ç«è»Š<br>æ•¸å­¸å¤§å†’éšª</h1>
                <p style="font-size: 1.2rem; color: #666; margin-bottom: 30px;">
                    å°å°ç«™é•·ï¼Œæº–å‚™å¥½å‡ºç™¼äº†å—ï¼Ÿ<br>
                    <small>æŒ‘æˆ° 60 ç§’æ‹¿é«˜åˆ†ï¼</small>
                </p>
                <button class="btn" onclick="startGame('normal')">ğŸ§® é‹ç®—æŒ‘æˆ° (ä¸€èˆ¬)</button>
                <br>
                <button class="btn btn-secondary" onclick="startGame('story')">ğŸ“– æ‡‰ç”¨é¡Œ (ç´ é¤Š)</button>
            </div>

            <div id="game-screen">
                <div class="info-bar">
                    <span>â­ åˆ†æ•¸: <span id="score" style="color:#D84315;">0</span></span>
                    <span>â±ï¸ æ™‚é–“: <span id="timer">60</span>s</span>
                </div>
                
                <div id="question-text" class="question-box">
                    é¡Œç›®æº–å‚™ä¸­...
                </div>

                <div id="options-area" class="options-grid"></div>
            </div>

            <div id="result-screen">
                <div class="train-icon">ğŸ</div>
                <h1 id="final-msg">çµ‚é»ç«™åˆ°äº†ï¼</h1>
                <p style="font-size: 1.3rem; margin: 20px;">
                    æ­å–œä½ å®Œæˆäº†å†’éšªï¼<br>
                    ä½ çš„ç¸½åˆ†æ˜¯ï¼š
                </p>
                <p style="font-size: 4rem; color:#D84315; font-weight:bold; margin: 0;">
                    <span id="final-score">0</span>
                </p>
                <br>
                <button class="btn" onclick="location.reload()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
            </div>
        </div>

        <div class="rules-footer">
            è¦å‰‡èªªæ˜ï¼š1. å…ˆä¹˜é™¤å¾ŒåŠ æ¸›ï¼Œæ‹¬è™Ÿå…§å…ˆç®—ã€‚<br>
            2. æœ¬éŠæˆ²é‹ç®—éç¨‹èˆ‡çµæœçš†ç‚ºæ­£æ•´æ•¸ (ç„¡è² æ•¸)ã€‚
        </div>

    </div>

    <script>
        // --- è®Šæ•¸èˆ‡éŸ³æ•ˆ ---
        let score = 0, timeLeft = 60, timerInterval, currentAnswer = 0, gameMode = 'normal', isAnswering = false;
        const sounds = {
            train: document.getElementById('sound-train'),
            correct: document.getElementById('sound-correct'),
            wrong: document.getElementById('sound-wrong')
        };

        function playSound(type) {
            try { if (sounds[type]) { sounds[type].currentTime = 0; sounds[type].play().catch(e => {}); } } catch(e) {}
        }

        // --- é¡Œåº« (ç´ é¤Šé¡Œ) ---
        const storyQuestions = [
            { q: "ç«è»Šæœ‰ 8 ç¯€è»Šå»‚ï¼Œæ¯ç¯€å 40 äººï¼Œä¸‹è»Š 50 äººå¾Œï¼Œå‰©å¹¾äººï¼Ÿ", a: 270 },
            { q: "ä¾¿ç•¶ä¸€å€‹ 80 å…ƒï¼Œè²· 3 å€‹ä¾¿ç•¶ï¼Œä»˜ 500 å…ƒï¼Œè¦æ‰¾å›å¤šå°‘ï¼Ÿ", a: 260 },
            { q: "å°æ˜æœ‰ 200 å…ƒï¼Œè²·æ¯æœ¬ 30 å…ƒçš„ç­†è¨˜æœ¬ 5 æœ¬ï¼Œå‰©å¤šå°‘éŒ¢ï¼Ÿ", a: 50 },
            { q: "é–€ç¥¨ä¸€å¼µ 450 å…ƒï¼Œ3 äººåŒè¡Œå…±æŠ˜ 100 å…ƒï¼Œéœ€ä»˜å¤šå°‘ï¼Ÿ", a: 1250 },
            { q: "24 é¡†è˜‹æœå¹³åˆ†çµ¦ 6 äººï¼Œå°è¯åƒæ‰ 2 é¡†ï¼Œä»–é‚„å‰©å¹¾é¡†ï¼Ÿ", a: 2 },
            { q: "ä¸€å°æ™‚æœ‰ 60 åˆ†é˜ï¼Œç«è»Šé–‹äº† 3 å°æ™‚åˆ 15 åˆ†é˜ï¼Œå…±å¹¾åˆ†é˜ï¼Ÿ", a: 195 },
            { q: "å¤§åº§è™Ÿæ˜¯ 35ï¼Œå°åº§è™Ÿæ˜¯ 12ï¼Œå…©æ•¸ç›¸ä¹˜å†æ¸›å» 100 æ˜¯å¤šå°‘ï¼Ÿ", a: 320 }
        ];

        // --- æµç¨‹æ§åˆ¶ ---
        function startGame(mode) {
            gameMode = mode; score = 0; timeLeft = 60;
            document.getElementById('score').innerText = score;
            document.getElementById('timer').innerText = timeLeft;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            document.querySelector('.rules-footer').style.display = 'none'; // éŠæˆ²ä¸­éš±è—è¦å‰‡ï¼Œè®“ç•«é¢æ›´ä¹¾æ·¨
            playSound('train');

            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                if(timeLeft <= 10) document.getElementById('timer').style.color = 'red';
                else document.getElementById('timer').style.color = '#555';
                if (timeLeft <= 0) endGame();
            }, 1000);
            nextQuestion();
        }

        function endGame() {
            clearInterval(timerInterval);
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';
            document.querySelector('.rules-footer').style.display = 'block'; // çµæŸå¾Œé¡¯ç¤ºå›ä¾†
            document.getElementById('final-score').innerText = score;
            if(score > 0) playSound('correct'); else playSound('train');
        }

        function nextQuestion() {
            isAnswering = false;
            document.getElementById('question-text').style.color = '#D84315';
            if (gameMode === 'story') generateStoryQuestion();
            else generateMathQuestion();
        }

        // --- åš´æ ¼æ•¸å­¸é‚è¼¯ (éç¨‹ç„¡è² æ•¸) ---
        function calculateStep(a, op, b) {
            let res;
            if (op === '+') res = a + b;
            if (op === '-') res = a - b;
            if (op === '*') res = a * b;
            if (op === '/') { if (b === 0) return null; res = a / b; }
            if (!Number.isInteger(res) || res < 0) return null; // ç¢ºä¿æ•´æ•¸ä¸”éè² 
            return res;
        }

        function generateMathQuestion() {
            let valid = false, questionText = "", answer = 0;
            while (!valid) {
                let n1 = getRandomInt(2, 20), n2 = getRandomInt(2, 20), n3 = getRandomInt(2, 20);
                let ops = ['+', '-', '*', '/'];
                let op1 = ops[Math.floor(Math.random() * 4)], op2 = ops[Math.floor(Math.random() * 4)];
                let type = Math.floor(Math.random() * 3);
                let step1, step2;

                if (type === 1) { // (A op B) op C
                    step1 = calculateStep(n1, op1, n2);
                    if (step1 !== null) {
                        step2 = calculateStep(step1, op2, n3);
                        if (step2 !== null && step2 < 500) {
                            valid = true; answer = step2;
                            questionText = `(${n1} ${toSymbol(op1)} ${n2}) ${toSymbol(op2)} ${n3} = ?`;
                        }
                    }
                } else if (type === 2) { // A op (B op C)
                    step1 = calculateStep(n2, op2, n3);
                    if (step1 !== null) {
                        step2 = calculateStep(n1, op1, step1);
                        if (step2 !== null && step2 < 500) {
                            valid = true; answer = step2;
                            questionText = `${n1} ${toSymbol(op1)} (${n2} ${toSymbol(op2)} ${n3}) = ?`;
                        }
                    }
                } else { // A op B op C
                    let op1_prio = (op1 === '*' || op1 === '/') ? 2 : 1;
                    let op2_prio = (op2 === '*' || op2 === '/') ? 2 : 1;
                    if (op2_prio > op1_prio) { // å…ˆç®—å¾Œ
                        step1 = calculateStep(n2, op2, n3);
                        if (step1 !== null) {
                            step2 = calculateStep(n1, op1, step1);
                            if (step2 !== null && step2 < 500) {
                                valid = true; answer = step2;
                                questionText = `${n1} ${toSymbol(op1)} ${n2} ${toSymbol(op2)} ${n3} = ?`;
                            }
                        }
                    } else { // å…ˆç®—å‰
                        step1 = calculateStep(n1, op1, n2);
                        if (step1 !== null) {
                            step2 = calculateStep(step1, op2, n3);
                            if (step2 !== null && step2 < 500) {
                                valid = true; answer = step2;
                                questionText = `${n1} ${toSymbol(op1)} ${n2} ${toSymbol(op2)} ${n3} = ?`;
                            }
                        }
                    }
                }
            }
            renderUI(questionText, answer);
        }

        function generateStoryQuestion() {
            const qData = storyQuestions[Math.floor(Math.random() * storyQuestions.length)];
            renderUI(qData.q, qData.a);
        }

        function renderUI(qText, ans) {
            currentAnswer = ans;
            document.getElementById('question-text').innerText = qText;
            let options = [ans];
            while (options.length < 4) {
                let fake = ans + getRandomInt(-20, 20);
                if (fake >= 0 && !options.includes(fake)) options.push(fake);
            }
            options.sort(() => Math.random() - 0.5);
            const container = document.getElementById('options-area');
            container.innerHTML = "";
            options.forEach(opt => {
                let btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = (e) => checkAnswer(opt, e.target);
                container.appendChild(btn);
            });
        }

        function checkAnswer(playerAns, btnElem) {
            if (isAnswering) return;
            isAnswering = true;
            if (playerAns === currentAnswer) {
                score += 10; playSound('correct'); btnElem.classList.add('correct-anim');
                document.getElementById('question-text').innerHTML = "<span style='color:#2E7D32'>ğŸ‰ ç­”å°äº†ï¼</span>";
            } else {
                timeLeft = Math.max(0, timeLeft - 5); playSound('wrong'); btnElem.classList.add('wrong-anim');
                document.getElementById('question-text').innerHTML = "<span style='color:#C62828'>âŒ å“å‘€ï¼ŒåŠ æ²¹ï¼</span>";
            }
            document.getElementById('score').innerText = score; document.getElementById('timer').innerText = timeLeft;
            setTimeout(() => { if (timeLeft > 0) nextQuestion(); }, 800);
        }

        function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        function toSymbol(op) { if (op === '*') return 'Ã—'; if (op === '/') return 'Ã·'; return op; }
    </script>
</body>
</html>