<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§è€³ç‹—ä¹ä¹ä¹˜æ³•ï¼šé€²éšç·´ç¿’ç‰ˆ</title>
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        :root {
            --primary-blue: #89CFF0; /* å¤§è€³ç‹—çš„å¤©ç©ºè— */
            --dark-blue: #5CA0C0;
            --soft-white: #FFFFFF;
            --accent-pink: #FFB7C5;
            --text-color: #555555;
            --bg-cloud: #F0F8FF;
        }

        body {
            font-family: "Varela Round", "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg-cloud);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* èƒŒæ™¯è£é£¾ï¼šæ¨¡æ“¬é›²æœµ */
            background-image: 
                radial-gradient(circle, white 20%, transparent 20%),
                radial-gradient(circle, white 20%, transparent 20%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            user-select: none; /* é˜²æ­¢å°æœ‹å‹èª¤é¸æ–‡å­— */
        }

        /* --- éŠæˆ²ä¸»å®¹å™¨ --- */
        #game-container {
            background: var(--soft-white);
            width: 95%;
            max-width: 600px;
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(137, 207, 240, 0.5);
            padding: 20px;
            text-align: center;
            border: 6px solid var(--primary-blue);
            box-sizing: border-box;
            position: relative;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        /* --- é€šç”¨ UI å…ƒä»¶ --- */
        h1 {
            color: var(--dark-blue);
            margin: 10px 0;
            font-size: 1.8rem;
        }

        .btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            padding: 15px 25px;
            font-size: 1.4rem;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 5px 0 #5CA0C0;
            transition: transform 0.1s, box-shadow 0.1s;
            font-weight: bold;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #5CA0C0;
        }

        .btn-secondary {
            background-color: var(--accent-pink);
            box-shadow: 0 5px 0 #E08FA0;
        }
        .btn-secondary:active {
            box-shadow: 0 1px 0 #E08FA0;
        }

        .btn-home {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 1rem;
            padding: 8px 15px;
            background: #ccc;
            box-shadow: 0 4px 0 #aaa;
        }

        /* --- åœ–ç‰‡å€åŸŸ --- */
        .character-img {
            width: 140px;
            height: 140px;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid var(--accent-pink);
            margin: 10px auto;
            background-color: #eee;
            display: block;
        }

        /* --- é¸å–®ç•«é¢ --- */
        #menu-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex-grow: 1;
        }

        .mode-section {
            margin: 20px 0;
            padding: 20px;
            background: #F9F9F9;
            border-radius: 20px;
            border: 2px dashed var(--primary-blue);
        }

        .mode-title {
            font-size: 1.5rem;
            color: var(--dark-blue);
            margin-bottom: 15px;
            display: block;
            font-weight: bold;
        }

        .grid-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .grid-buttons .btn {
            margin: 0; /* é‡ç½® margin */
            font-size: 1.5rem;
            padding: 15px 0;
        }

        /* --- éŠæˆ²ç•«é¢ --- */
        #game-screen {
            display: none; /* é è¨­éš±è— */
            flex-direction: column;
            height: 100%;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 10px;
        }

        .score-display {
            font-size: 1.2rem;
            color: var(--dark-blue);
            font-weight: bold;
            background: #E0F7FA;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .question-box {
            font-size: 3.5rem; /* é¡Œç›®ç‰¹å¤§ */
            color: var(--text-color);
            margin: 10px 0;
            font-weight: bold;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .story-text {
            font-size: 1.6rem;
            color: #444;
            text-align: left;
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            line-height: 1.5;
            border: 2px solid var(--primary-blue);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .highlight {
            color: #E91E63;
            font-weight: bold;
            font-size: 1.8rem;
            padding: 0 5px;
        }

        /* --- ç­”æ¡ˆè¼¸å…¥èˆ‡éµç›¤ --- */
        #answer-display {
            font-size: 2.8rem;
            color: var(--primary-blue);
            border-bottom: 4px solid var(--primary-blue);
            display: inline-block;
            min-width: 120px;
            height: 60px;
            margin-bottom: 10px;
            line-height: 60px;
        }

        #feedback-msg {
            height: 30px;
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .correct { color: #4CAF50; }
        .wrong { color: #FF6B6B; }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
        }

        .key-btn {
            background-color: white;
            border: 2px solid var(--primary-blue);
            border-radius: 15px;
            color: var(--text-color);
            font-size: 2rem;
            padding: 12px 0;
            cursor: pointer;
            box-shadow: 0 3px 0 #ddd;
        }

        .key-btn:active {
            transform: translateY(2px);
            box-shadow: none;
            background-color: var(--primary-blue);
            color: white;
        }

        .key-action {
            background-color: var(--accent-pink);
            border-color: var(--accent-pink);
            color: white;
            box-shadow: 0 3px 0 #E08FA0;
        }

        /* ä¸Šä¸€é¡ŒæŒ‰éˆ• */
        .btn-undo {
            background-color: #FFD700;
            box-shadow: 0 4px 0 #DAA520;
            font-size: 1rem;
            padding: 8px 15px;
            margin-right: auto; /* é å·¦ */
        }
        .btn-undo:disabled {
            background-color: #ddd;
            box-shadow: none;
            cursor: not-allowed;
        }

        /* éš±è—å…ƒç´  class */
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div id="game-container">
        
        <div id="menu-screen">
            <img src="https://placehold.co/150x150/89CFF0/FFFFFF?text=Cute+Dog" alt="å¤§è€³ç‹—" class="character-img" id="menu-img">
            <h1>å¤§è€³ç‹—ä¹ä¹ä¹˜æ³•</h1>
            
            <div class="mode-section">
                <span class="mode-title">â¶ åŸºç¤ç·´ç¿’ï¼šé¸æ“‡æ•¸å­—</span>
                <div class="grid-buttons">
                    <button class="btn" onclick="startGame('basic', 2)">2</button>
                    <button class="btn" onclick="startGame('basic', 3)">3</button>
                    <button class="btn" onclick="startGame('basic', 4)">4</button>
                    <button class="btn" onclick="startGame('basic', 5)">5</button>
                    <button class="btn" onclick="startGame('basic', 6)">6</button>
                    <button class="btn" onclick="startGame('basic', 7)">7</button>
                    <button class="btn" onclick="startGame('basic', 8)">8</button>
                    <button class="btn" onclick="startGame('basic', 9)">9</button>
                </div>
                <div style="margin-top: 10px;">
                    <button class="btn btn-secondary" style="width: 80%" onclick="startGame('basic', 0)">å…¨éƒ¨æ··å’Œç·´ç¿’</button>
                </div>
            </div>

            <div class="mode-section">
                <span class="mode-title">â· é€²éšæŒ‘æˆ°ï¼šæ‡‰ç”¨é¡Œ</span>
                <button class="btn btn-secondary" style="width: 80%; background-color: #FF9800; box-shadow: 0 5px 0 #E65100;" onclick="startGame('story', 0)">é–‹å§‹ç´ é¤ŠæŒ‘æˆ°</button>
            </div>
        </div>

        <div id="game-screen">
            <div class="top-bar">
                <button class="btn btn-undo" id="btn-back" onclick="goBack()">â†© ä¸Šä¸€é¡Œ</button>
                <div class="score-display">â­ <span id="score">0</span> åˆ†</div>
                <button class="btn btn-home" onclick="goHome()">ğŸ  å›é¦–é </button>
            </div>

            <img src="https://placehold.co/150x150/89CFF0/FFFFFF?text=Thinking" alt="æ€è€ƒä¸­" class="character-img" id="game-img">
            
            <div id="question-area"></div>

            <div id="answer-display">?</div>
            <div id="feedback-msg"></div>

            <div class="numpad">
                <button class="key-btn" onclick="inputNum(1)">1</button>
                <button class="key-btn" onclick="inputNum(2)">2</button>
                <button class="key-btn" onclick="inputNum(3)">3</button>
                <button class="key-btn" onclick="inputNum(4)">4</button>
                <button class="key-btn" onclick="inputNum(5)">5</button>
                <button class="key-btn" onclick="inputNum(6)">6</button>
                <button class="key-btn" onclick="inputNum(7)">7</button>
                <button class="key-btn" onclick="inputNum(8)">8</button>
                <button class="key-btn" onclick="inputNum(9)">9</button>
                <button class="key-btn key-action" onclick="clearInput()">C</button>
                <button class="key-btn" onclick="inputNum(0)">0</button>
                <button class="key-btn key-action" onclick="submitAnswer()">OK</button>
            </div>
        </div>

    </div>

    <script>
        /**
         * åœ–ç‰‡è¨­å®šèªªæ˜ï¼š
         * æ‚¨å¯ä»¥å°‡ä¸‹æ–¹çš„ç¶²å€æ›¿æ›æˆæ‚¨å–œæ­¡çš„å¤§è€³ç‹—åœ–ç‰‡é€£çµ (å¿…é ˆä»¥ .jpg æˆ– .png çµå°¾)ã€‚
         * å¦‚æœæ²’æœ‰é€£çµï¼Œç¨‹å¼æœƒä½¿ç”¨é è¨­çš„å¯æ„›è‰²å¡Šåœ–ã€‚
         */
        const IMAGES = {
            normal: "https://placehold.co/150x150/89CFF0/FFFFFF?text=Hello", // ä¸€èˆ¬è¡¨æƒ…
            happy: "https://placehold.co/150x150/98FB98/FFFFFF?text=Happy!",  // ç­”å°è¡¨æƒ…
            sad: "https://placehold.co/150x150/FFB7C5/FFFFFF?text=Try+Again" // ç­”éŒ¯è¡¨æƒ…
        };

        // --- ç´ é¤Šé¡Œåº« (é€²éšé¡Œ) ---
        // é€™äº›é¡Œç›®ä¸æœƒåœ¨åŸºç¤æ¨¡å¼å‡ºç¾
        const storyQuestions = [
            { t: "ä¸€éš»å¤§è€³ç‹—æœ‰ <span class='highlight'>2</span> åªè€³æœµï¼Œ<br>è«‹å• <span class='highlight'>6</span> éš»å¤§è€³ç‹—å…±æœ‰å¹¾åªè€³æœµï¼Ÿ", a: 12 },
            { t: "å’–å•¡åº—è£¡ä¸€å¼µæ¡Œå­æœ‰ <span class='highlight'>4</span> éš»è…³ï¼Œ<br>åº—è£¡æœ‰ <span class='highlight'>5</span> å¼µæ¡Œå­ï¼Œ<br>è«‹å•å…±æœ‰å¹¾éš»è…³ï¼Ÿ", a: 20 },
            { t: "ä¸€å€‹è‚‰æ¡‚æ²è³£ <span class='highlight'>9</span> å…ƒï¼Œ<br>å¦¹å¦¹è²·äº† <span class='highlight'>3</span> å€‹ï¼Œ<br>è«‹å•è¦ä»˜å¤šå°‘éŒ¢ï¼Ÿ", a: 27 },
            { t: "ä¸€æ˜ŸæœŸæœ‰ <span class='highlight'>7</span> å¤©ï¼Œ<br>æ”¾æš‘å‡æ”¾äº† <span class='highlight'>4</span> å€‹æ˜ŸæœŸï¼Œ<br>è«‹å•ç¸½å…±æ”¾äº†å¹¾å¤©ï¼Ÿ", a: 28 },
            { t: "ä¸€ç›’å½©è‰²ç­†æœ‰ <span class='highlight'>8</span> æï¼Œ<br>è€å¸«è²·äº† <span class='highlight'>5</span> ç›’é€çµ¦å°æœ‹å‹ï¼Œ<br>å…±æœ‰å¹¾æå½©è‰²ç­†ï¼Ÿ", a: 40 },
            { t: "å¤§è€³ç‹—æ¯å¤©é£› <span class='highlight'>3</span> å…¬é‡Œï¼Œ<br>é€£çºŒé£›äº† <span class='highlight'>9</span> å¤©ï¼Œ<br>ç¸½å…±é£›äº†å¤šå°‘å…¬é‡Œï¼Ÿ", a: 27 },
            { t: "æ‘©å¤©è¼ªä¸€å€‹è»Šå»‚å¯ä»¥å <span class='highlight'>6</span> äººï¼Œ<br>ç¾åœ¨æœ‰ <span class='highlight'>8</span> å€‹è»Šå»‚åæ»¿äº†äººï¼Œ<br>è«‹å•å…±æœ‰å¤šå°‘äººï¼Ÿ", a: 48 },
            { t: "ä¸€åŒ…ç³–æœæœ‰ <span class='highlight'>5</span> é¡†ï¼Œ<br>åª½åª½è²·äº† <span class='highlight'>7</span> åŒ…ï¼Œ<br>å…¨éƒ¨æœ‰å¹¾é¡†ç³–æœï¼Ÿ", a: 35 }
        ];

        // --- éŠæˆ²ç‹€æ…‹è®Šæ•¸ ---
        let state = {
            mode: 'basic',   // 'basic' æˆ– 'story'
            targetNum: 0,    // 0=å…¨ç¯„åœ, 2-9=æŒ‡å®šæ•¸å­—
            currentQ: null,  // ç•¶å‰é¡Œç›®ç‰©ä»¶ {text, ans, displayType}
            input: "",       // ä½¿ç”¨è€…è¼¸å…¥
            score: 0,
            history: []      // æ­·å²ç´€éŒ„ï¼Œç”¨æ–¼"ä¸Šä¸€é¡Œ"
        };

        // --- åˆå§‹åŒ–èˆ‡é¸å–®é‚è¼¯ ---

        function goHome() {
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('menu-screen').style.display = 'flex';
        }

        function startGame(mode, num) {
            state.mode = mode;
            state.targetNum = num;
            state.score = 0;
            state.history = []; // æ¸…ç©ºæ­·å²
            state.input = "";
            
            document.getElementById('score').innerText = 0;
            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            
            nextQuestion(false); // false ä»£è¡¨ä¸æ˜¯å¾ä¸Šä¸€é¡Œå›ä¾†çš„
        }

        // --- é¡Œç›®ç”Ÿæˆé‚è¼¯ ---

        function generateQuestion() {
            let qText = "";
            let qAns = 0;
            let qType = "basic"; // ç”¨æ–¼ CSS æ¨£å¼åˆ¤æ–·

            if (state.mode === 'story') {
                // ç´ é¤Šé¡Œæ¨¡å¼ï¼šå¾é¡Œåº«éš¨æ©ŸæŠ½
                const q = storyQuestions[Math.floor(Math.random() * storyQuestions.length)];
                qText = q.t;
                qAns = q.a;
                qType = "story";
            } else {
                // åŸºç¤æ¨¡å¼ï¼šä¹ä¹ä¹˜æ³•
                let n1, n2;
                if (state.targetNum === 0) {
                    // éš¨æ©Ÿ (2~9) * (1~9)
                    n1 = Math.floor(Math.random() * 8) + 2; 
                    n2 = Math.floor(Math.random() * 9) + 1;
                } else {
                    // æŒ‡å®šæ•¸å­—ï¼Œä¾‹å¦‚ 3çš„ä¹˜æ³•
                    n1 = state.targetNum;
                    n2 = Math.floor(Math.random() * 9) + 1;
                }
                qText = `${n1} Ã— ${n2} = ?`;
                qAns = n1 * n2;
            }

            return { text: qText, ans: qAns, type: qType, solved: false };
        }

        function nextQuestion(isUndo) {
            // å¦‚æœä¸æ˜¯ Undo æ“ä½œï¼Œæ‰ç”¢ç”Ÿæ–°é¡Œç›®
            if (!isUndo) {
                // å¦‚æœç•¶å‰æœ‰é¡Œç›®ï¼Œå…ˆå­˜å…¥æ­·å² (åŒ…å«ä½¿ç”¨è€…æ˜¯å¦ç­”å°çš„ç‹€æ…‹å¯é¸ï¼Œé€™è£¡ç°¡åŒ–ç‚ºå­˜é¡Œç›®æœ¬èº«)
                if (state.currentQ) {
                    state.history.push({ ...state.currentQ }); // æ·ºæ‹·è²å­˜æª”
                }
                state.currentQ = generateQuestion();
            }
            
            // æ¸²æŸ“ç•«é¢
            renderGame();
        }

        function goBack() {
            if (state.history.length === 0) return;

            // å–å‡ºä¸Šä¸€é¡Œ
            const prevQ = state.history.pop();
            state.currentQ = prevQ;
            
            // é€™è£¡é‚è¼¯ï¼šå›åˆ°ä¸Šä¸€é¡Œæ™‚ï¼ŒæŠŠåˆ†æ•¸æ‰£æ‰è©²é¡Œå¯èƒ½çš„å¾—åˆ†å—ï¼Ÿ
            // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘å‡è¨­å›åˆ°ä¸Šä¸€é¡Œæ˜¯ç‚ºäº†ã€Œé‡çœ‹ã€ï¼Œè¼¸å…¥æ¡†æ¸…ç©ºè®“ä»–å€‘é‡ç­”
            // æˆ–è€…ä¿ç•™ä¹‹å‰çš„å›ç­”ï¼Ÿç‚ºäº†ç·´ç¿’ï¼Œæˆ‘å€‘è®“ä½¿ç”¨è€…é‡ç­”ã€‚
            
            renderGame();
        }

        function renderGame() {
            const qArea = document.getElementById('question-area');
            const img = document.getElementById('game-img');
            const feedback = document.getElementById('feedback-msg');
            const btnBack = document.getElementById('btn-back');

            // é‡ç½®è¼¸å…¥èˆ‡å›é¥‹
            state.input = "";
            document.getElementById('answer-display').innerText = "?";
            feedback.innerText = "";
            feedback.className = "";
            img.src = IMAGES.normal;

            // é¡¯ç¤ºé¡Œç›®
            if (state.currentQ.type === 'story') {
                qArea.innerHTML = `<div class='story-text'>${state.currentQ.text}</div>`;
            } else {
                qArea.innerHTML = `<div class='question-box'>${state.currentQ.text}</div>`;
            }

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            btnBack.disabled = (state.history.length === 0);
        }

        // --- è¼¸å…¥è™•ç† ---

        function inputNum(n) {
            if (state.input.length < 3) {
                state.input += n;
                document.getElementById('answer-display').innerText = state.input;
            }
        }

        function clearInput() {
            state.input = "";
            document.getElementById('answer-display').innerText = "?";
        }

        function submitAnswer() {
            if (state.input === "") return;

            const val = parseInt(state.input);
            const feedback = document.getElementById('feedback-msg');
            const img = document.getElementById('game-img');

            if (val === state.currentQ.ans) {
                // ç­”å°
                feedback.innerText = "â˜… ç­”å°äº†ï¼å¥½æ£’ï¼ â˜…";
                feedback.className = "correct";
                img.src = IMAGES.happy;
                
                // åªæœ‰æ²’è§£éçš„é¡Œç›®æ‰åŠ åˆ† (é˜²æ­¢ä¾†å›åˆ·åˆ†ï¼Œé›–ç„¶é€™è£¡ç°¡å–®ç‰ˆæ²’åš´æ ¼é™åˆ¶)
                state.score += 10;
                document.getElementById('score').innerText = state.score;

                // æ¨™è¨˜ç‚ºå·²è§£æ±º (é›–ç„¶ä¸‹ä¸€é¡Œæœƒç”Ÿæˆæ–°çš„)
                state.currentQ.solved = true;

                setTimeout(() => nextQuestion(false), 1200);
            } else {
                // ç­”éŒ¯
                feedback.innerText = "ä¸å°å–”ï¼ŒåŠ æ²¹ï¼";
                feedback.className = "wrong";
                img.src = IMAGES.sad;
                state.input = "";
                document.getElementById('answer-display').innerText = "?";
            }
        }

    </script>
</body>
</html>
